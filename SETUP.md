# Инструкция по настройке Sparkaph

## Ошибка подключения к MongoDB

Если вы получаете следующую ошибку:
```
SSL handshake failed: [SSL: TLSV1_ALERT_INTERNAL_ERROR] tlsv1 alert internal error (_ssl.c:1006)
```

Это значит, что у вас проблемы с подключением к MongoDB Atlas. Вот пошаговое решение:

### 1. Обновите MongoDB Atlas

1. Войдите в [MongoDB Atlas](https://cloud.mongodb.com/)
2. Выберите ваш кластер
3. Перейдите в "Network Access" (Сетевой доступ)
4. Нажмите "ADD IP ADDRESS" (Добавить IP-адрес)
5. Выберите "Allow access from anywhere" (0.0.0.0/0) или добавьте ваш текущий IP
6. Нажмите "Confirm" (Подтвердить)

### 2. Используйте правильную строку подключения

Убедитесь, что ваша строка подключения в `.env` файле правильная:

```
MONGODB_URI=mongodb+srv://Stexiel:ASER2007@cluster0.h0r4kz4.mongodb.net/Sparkaph?retryWrites=true&w=majority&tlsAllowInvalidCertificates=true
```

### 3. Проверьте MongoDB подключение

Запустите тестовый скрипт:
```
python mongo_test.py
```

Если он также показывает ошибки, пройдите следующие шаги:

1. Зайдите в MongoDB Atlas
2. Нажмите "Connect" для вашего кластера
3. Выберите "Connect your application"
4. Скопируйте новую строку подключения и используйте её

## Запуск ботов

### Важно: решение проблемы "Conflict"

Ошибка `Conflict: terminated by other getUpdates request` означает, что этот бот уже запущен где-то ещё. 

**Решение:**
1. Проверьте, не запущены ли ваши боты на Railway/Render или других сервисах
2. Остановите все текущие экземпляры ботов
3. Запускайте только один экземпляр каждого бота

### Запуск локально

**Вариант 1: Запустить только пользовательского бота:**
```
python start_user_bot.py
```

**Вариант 2: Запустить только админского бота:**
```
python start_admin_bot.py
```

### Запуск на Railway

**Настройте три отдельных сервиса:**

1. **Сервис healthcheck:**
   - Command: `python healthcheck.py`
   - Важен для поддержания активности вашего приложения

2. **Сервис пользовательского бота:**
   - Command: `python start_user_bot.py`

3. **Сервис админского бота:**
   - Command: `python start_admin_bot.py`

## Использование режима заглушки MongoDB

Боты настроены так, что будут работать даже без реальной базы данных. Если подключение к MongoDB не удаётся, боты автоматически переключаются в режим заглушки (mock mode).

В этом режиме:
- Боты запустятся без ошибок
- Команды бота будут работать (в ограниченном режиме)
- Данные не будут сохраняться
- Вы получите предупреждения в логах о работе в режиме заглушки

Используйте команду `/dbtest` в обоих ботах, чтобы проверить статус подключения к базе данных.

## Команды для отладки

- `/dbtest` - проверить подключение к MongoDB
- `/stats` - показать статистику (только в админском боте)

## Полезные рекомендации

1. Используйте актуальную версию pymongo (4.6.1)
2. Добавьте параметр `tlsAllowInvalidCertificates=true` в строку подключения MongoDB
3. Если проблема с подключением к MongoDB сохраняется, рассмотрите возможность создания нового кластера
4. На Railway/Render используйте отдельные сервисы для каждого бота 