# Sparkaph - Telegram Bot

Проект Sparkaph представляет собой два Telegram бота: пользовательский и администраторский, для проведения челленджей и заданий.

## Настройка и запуск

### Локальный запуск

1. Установите зависимости:
```
pip install -r requirements.txt
```

2. Запуск ботов:

**Запуск обоих ботов одновременно:**
```
python main.py
```

**Запуск только пользовательского бота:**
```
python start_user_bot.py
```

**Запуск только админского бота:**
```
python start_admin_bot.py
```

### Деплой на Railway

1. Подключите репозиторий к Railway
2. Установите переменные окружения:
   - `MONGODB_URI`: строка подключения к MongoDB
   - `USER_BOT_TOKEN`: токен пользовательского бота
   - `ADMIN_BOT_TOKEN`: токен администраторского бота
   - `CHANNEL_ID`: ID канала (например, @SparkaphChannel)
   - `ADMIN_ID`: ID администратора

3. Используйте отдельные сервисы для каждого бота в Railway:
   - Основной сервис: `healthcheck.py` (для поддержания жизни)
   - Отдельный сервис: `start_user_bot.py` (пользовательский бот)
   - Отдельный сервис: `start_admin_bot.py` (админский бот)

## Решение проблем

### Ошибки подключения к MongoDB

Если вы получаете ошибки SSL/TLS при подключении к MongoDB Atlas:

1. **Добавьте свой IP в белый список MongoDB Atlas**:
   - Войдите в MongoDB Atlas
   - Перейдите к вашему кластеру
   - Нажмите "Network Access"
   - Добавьте свой текущий IP или 0.0.0.0/0 для доступа отовсюду

2. **Проверьте строку подключения**:
   - Строка подключения должна быть корректной
   - Для обхода проблем с SSL добавьте `tlsAllowInvalidCertificates=true` 

3. **Используйте режим заглушки MongoDB**:
   - Боты настроены на работу даже без подключения к базе данных
   - В режиме заглушки функциональность ограничена, но боты не будут падать

### Ошибка Telegram "Conflict: terminated by other getUpdates request"

Эта ошибка возникает при попытке запустить несколько экземпляров одного и того же бота:

1. Убедитесь, что у вас запущен только один экземпляр каждого бота
2. Используйте отдельные скрипты для запуска каждого бота
3. Проверьте, не запущены ли боты на других серверах

## Архитектура

- **user_bot.py**: Пользовательский бот для работы с конечными пользователями
- **admin_bot.py**: Административный бот для управления челленджами
- **healthcheck.py**: HTTP-сервер для проверки работоспособности
- **main.py**: Скрипт для запуска обоих ботов
- **start_user_bot.py**: Скрипт для запуска только пользовательского бота
- **start_admin_bot.py**: Скрипт для запуска только административного бота

## Функциональность

### Пользовательский бот
- Регистрация и выбор челленджей по категориям
- Отправка фото/видео/текста с результатами выполнения
- Напоминания о выполнении через 6 и 10 часов
- Рейтинговая система с очками
- Статистика личных достижений
- Автоматическая проверка подписки на канал

### Админский бот
- Проверка и подтверждение/отклонение челленджей
- Управление категориями и челленджами
- Подробная статистика для инвесторов:
  - DAU/WAU/MAU метрики
  - Retention за день/неделю/3 недели
  - Демографическая статистика
  - Статистика по категориям и выполнениям

## Технический стек
- Python 3.10+
- aiogram 3.x (Telegram Bot API)
- MongoDB (для хранения данных)
- Бесплатный хостинг (Render/Railway/Cyclic)

## База данных MongoDB

### Структура коллекций

#### users
- `user_id`: ID пользователя Telegram
- `username`: Имя пользователя
- `points`: Очки пользователя
- `current_challenge`: ID текущего челленджа
- `completed_challenges`: Массив ID выполненных челленджей
- `subscription`: Статус подписки на канал
- `joined_at`: Дата регистрации
- `last_activity`: Дата последней активности
- `challenge_started_at`: Время начала текущего челленджа
- `gender`: Пол пользователя
- `age`: Возрастная группа

#### categories
- `name`: Название категории
- `description`: Описание категории
- `created_at`: Дата создания

#### challenges
- `category_id`: ID категории
- `text`: Текст челленджа
- `description`: Описание (опционально)
- `max_users`: Максимальное количество пользователей
- `taken_by`: Массив ID пользователей, взявших челлендж
- `status`: Статус челленджа (active/disabled)
- `created_at`: Дата создания

#### submissions
- `user_id`: ID пользователя
- `challenge_id`: ID челленджа
- `text`: Текстовый ответ
- `media`: ID медиа (фото/видео)
- `media_type`: Тип медиа
- `submitted_at`: Время отправки
- `reviewed_at`: Время проверки
- `status`: Статус (pending/approved/rejected)
- `reject_reason`: Причина отказа (если отклонено)

## Контактная информация

По всем вопросам обращайтесь: @AserAbiken # Sparkaph
